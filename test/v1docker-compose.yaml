services:
  vpnserver:
    image: weejewel/wg-easy
    container_name: VPNserver
    # restart: unless-stopped   
    ports:
      - "51827:51820/udp"
      - "8799:51821/tcp"      
    volumes:
      - ./wg-easy:/etc/wireguard  
    environment:
      - WG_HOST=192.168.100.100      
      - PASSWORD=admin
      - WG_PORT=51820
      - WG_MTU=1420
      - WG_PERSISTENT_KEEPALIVE=25
      - WG_DEFAULT_ADDRESS=10.0.0.x
      - WG_DEFAULT_DNS=1.1.1.1, 8.8.8.8
      - WG_ALLOWED_IPS=0.0.0.0/0
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    networks:      
      wan:
        ipv4_address: 192.168.100.100       



  server-local:
    build:
      context: .
      dockerfile: server-local/Dockerfile   
    container_name: server-local
    restart: unless-stopped    
    volumes:
      - ./server-local/etc/wireguard:/etc/wireguard  # ใช้ $(pwd) ใน docker-compose ให้ใช้ relative path
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1      
    tty: true
    stdin_open: true  # เทียบเท่ากับ --interactive
    networks:      
      wan:
        ipv4_address: 192.168.100.50       
      lan1:
        ipv4_address: 192.168.200.50  
# sudo docker stop IperfClient1
# sudo docker rm IperfClient1

# docker exec -it IperfClient1 bash
# iperf3 -c 192.168.110.100 -t 1
# docker exec IperfClient1 iperf3 -c 192.168.110.100 -t 1
# sudo docker exec IperfClient1 ping 172.16.10.200
#######################################################
  user-test:
    build:
      context: .
      dockerfile: user-test/Dockerfile   
    # image: felixfischer/wireguard:latest
    container_name: user-test
    restart: unless-stopped    
    volumes:
      - ./user-test/etc/wireguard:/etc/wireguard  # ใช้ $(pwd) ใน docker-compose ให้ใช้ relative path
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1      
    tty: true
    stdin_open: true  # เทียบเท่ากับ --interactive
    networks:      
      wan:
        ipv4_address: 192.168.100.35       


networks:
  wan:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.100.0/24

  lan1:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.200.0/24